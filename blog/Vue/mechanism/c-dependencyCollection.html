<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>响应式系统的依赖收集追踪原理 | XXY BLOG</title>
    <meta name="description" content="xinxingyu">
    <link rel="icon" href="/blog/icon.jpg">
    
    <link rel="preload" href="/blog/assets/css/0.styles.135557ac.css" as="style"><link rel="preload" href="/blog/assets/js/app.99e55c7a.js" as="script"><link rel="preload" href="/blog/assets/js/27.b5fe4b73.js" as="script"><link rel="prefetch" href="/blog/assets/js/12.8487b97f.js"><link rel="prefetch" href="/blog/assets/js/2.474b2bf3.js"><link rel="prefetch" href="/blog/assets/js/3.794017d5.js"><link rel="prefetch" href="/blog/assets/js/4.c25fe7d1.js"><link rel="prefetch" href="/blog/assets/js/5.75df229c.js"><link rel="prefetch" href="/blog/assets/js/6.c99ec281.js"><link rel="prefetch" href="/blog/assets/js/7.e5bf4c61.js"><link rel="prefetch" href="/blog/assets/js/8.3a29d256.js"><link rel="prefetch" href="/blog/assets/js/9.f4db0827.js"><link rel="prefetch" href="/blog/assets/js/10.2ac396c6.js"><link rel="prefetch" href="/blog/assets/js/11.4b651826.js"><link rel="prefetch" href="/blog/assets/js/13.e77a3946.js"><link rel="prefetch" href="/blog/assets/js/14.d5e2923f.js"><link rel="prefetch" href="/blog/assets/js/15.8fcdef8d.js"><link rel="prefetch" href="/blog/assets/js/16.b923088c.js"><link rel="prefetch" href="/blog/assets/js/17.23ea663d.js"><link rel="prefetch" href="/blog/assets/js/18.45a18cbc.js"><link rel="prefetch" href="/blog/assets/js/19.a177b68a.js"><link rel="prefetch" href="/blog/assets/js/20.2d03c574.js"><link rel="prefetch" href="/blog/assets/js/21.07cadb55.js"><link rel="prefetch" href="/blog/assets/js/22.8fa86e6e.js"><link rel="prefetch" href="/blog/assets/js/23.4c8f77ee.js"><link rel="prefetch" href="/blog/assets/js/24.72098588.js"><link rel="prefetch" href="/blog/assets/js/25.092c9dfc.js"><link rel="prefetch" href="/blog/assets/js/26.69c13e52.js"><link rel="prefetch" href="/blog/assets/js/28.8d1e55ef.js"><link rel="prefetch" href="/blog/assets/js/29.7db19a0f.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.135557ac.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container base"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">XXY BLOG</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/blog/Vue/" class="nav-link router-link-active">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/CompilersPrinciples/" class="nav-link">编译原理</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/Frame/" class="nav-link">Frame</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/Css/" class="nav-link">Css</a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">About</a></div> <a href="https://github.com/xinxingyu" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/blog/Vue/" class="nav-link router-link-active">Vue</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/CompilersPrinciples/" class="nav-link">编译原理</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/Frame/" class="nav-link">Frame</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/JavaScript/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/blog/blog/Css/" class="nav-link">Css</a></li></ul></div></div><div class="nav-item"><a href="/blog/about/" class="nav-link">About</a></div> <a href="https://github.com/xinxingyu" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><a href="/blog/blog/Vue/dataBinding.html" class="sidebar-link">双向数据绑定</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>mechanism</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/blog/blog/Vue/mechanism/a-overview.html" class="sidebar-link">Vue.js 运行机制全局概览</a></li><li><a href="/blog/blog/Vue/mechanism/b-responsive.html" class="sidebar-link">响应式系统的基本原理</a></li><li><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html" class="active sidebar-link">响应式系统的依赖收集追踪原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html#为什么要依赖收集？" class="sidebar-link">为什么要依赖收集？</a></li><li class="sidebar-sub-header"><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html#订阅者-dep" class="sidebar-link">订阅者 Dep</a></li><li class="sidebar-sub-header"><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html#观察者-watcher" class="sidebar-link">观察者 Watcher</a></li><li class="sidebar-sub-header"><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html#依赖收集" class="sidebar-link">依赖收集</a></li><li class="sidebar-sub-header"><a href="/blog/blog/Vue/mechanism/c-dependencyCollection.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog/blog/Vue/mechanism/d-virtualDOM.html" class="sidebar-link">实现 Virtual DOM 下的一个 VNode 节点</a></li><li><a href="/blog/blog/Vue/mechanism/e-templateCompile.html" class="sidebar-link">template 模板是怎样通过 Compile 编译的</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="响应式系统的依赖收集追踪原理"><a href="#响应式系统的依赖收集追踪原理" aria-hidden="true" class="header-anchor">#</a> 响应式系统的依赖收集追踪原理</h1> <h2 id="为什么要依赖收集？"><a href="#为什么要依赖收集？" aria-hidden="true" class="header-anchor">#</a> 为什么要依赖收集？</h2> <p>先举个栗子🌰
我们现在有这么一个 Vue 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span>
        <span class="token template-string"><span class="token string">`&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt;
            &lt;span&gt;{{text2}}&lt;/span&gt;
        &lt;div&gt;`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        text1<span class="token punctuation">:</span> <span class="token string">'text1'</span><span class="token punctuation">,</span>
        text2<span class="token punctuation">:</span> <span class="token string">'text2'</span><span class="token punctuation">,</span>
        text3<span class="token punctuation">:</span> <span class="token string">'text3'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后我们做了这么一个操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>text3 <span class="token operator">=</span> <span class="token string">'modify text3'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>8
我们修改了 <code>data</code> 中 <code>text3</code> 的数据，但是因为视图中并不需要用到 <code>text3</code> ，所以我们并不需要触发上一章所讲的 <code>cb</code> 函数来更新视图，调用 <code>cb</code> 显然是不正确的。</p> <p>再来一个栗子🌰</p> <p>假设我们现在有一个全局的对象，我们可能会在多个 Vue 对象中用到它进行展示。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> globalObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    text1<span class="token punctuation">:</span> <span class="token string">'text1'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span>
        <span class="token template-string"><span class="token string">`&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt;
        &lt;div&gt;`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> globalObj
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    template<span class="token punctuation">:</span>
        <span class="token template-string"><span class="token string">`&lt;div&gt;
            &lt;span&gt;{{text1}}&lt;/span&gt;
        &lt;div&gt;`</span></span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> globalObj
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这个时候，我们执行了如下操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>globalObj<span class="token punctuation">.</span>text1 <span class="token operator">=</span> <span class="token string">'hello,text1'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们应该需要通知 <code>o1</code> 以及 <code>o2</code> 两个vm实例进行视图的更新， <strong>「依赖收集」</strong> 会让 <code>text1</code> 这个数据知道“哦～有两个地方依赖我的数据，我变化的时候需要通知它们～”。</p> <p>最终会形成数据与视图的一种对应关系，如下图。
<img src="data:image/jpeg;base64,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" alt></p> <h2 id="订阅者-dep"><a href="#订阅者-dep" aria-hidden="true" class="header-anchor">#</a> 订阅者 Dep</h2> <p>首先我们来实现一个订阅者 Dep ，它的主要作用是用来存放 <code>Watcher</code> 观察者对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 用来存放Watcher对象的数组 */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 在subs中添加一个Watcher对象 */</span>
    <span class="token function">addSub</span> <span class="token punctuation">(</span>sub<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 通知所有Watcher对象更新视图 */</span>
    <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>为了便于理解我们只实现了添加的部分代码，主要是两件事情：</p> <ol><li>用 <code>addSub</code> 方法可以在目前的 <code>Dep</code> 对象中增加一个 <code>Watcher</code> 的订阅操作；</li> <li>用 <code>notify</code> 方法通知目前 <code>Dep</code> 对象的 <code>subs</code> 中的所有 <code>Watcher</code> 对象触发更新操作。</li></ol> <h2 id="观察者-watcher"><a href="#观察者-watcher" aria-hidden="true" class="header-anchor">#</a> 观察者 Watcher</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* 在new一个Watcher对象时将该对象赋值给Dep.target，在get中会用到 */</span>
        Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 更新视图的方法 */</span>
    <span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;视图更新啦～&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="依赖收集"><a href="#依赖收集" aria-hidden="true" class="header-anchor">#</a> 依赖收集</h2> <p>接下来我们修改一下 <code>defineReactive</code> 以及 Vue 的构造函数，来完成依赖收集。</p> <p>我们在闭包中增加了一个 <code>Dep</code> 类的对象，用来收集 <code>Watcher</code> 对象。在对象被「读」的时候，会触发 <code>reactiveGetter</code> 函数把当前的 <code>Watcher</code> 对象（存放在 Dep.target 中）收集到 <code>Dep</code> 类中去。之后如果当该对象被「写」的时候，则会触发 <code>reactiveSetter</code> 方法，通知 <code>Dep</code> 类调用 <code>notify</code> 来触发所有 <code>Watcher</code> 对象的 <code>update</code> 方法更新对应视图。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 一个Dep类对象 */</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enumerable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token keyword">get</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/* 将Dep.target（即当前的Watcher对象存入dep的subs中） */</span>
            dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment">/* 在set的时候触发dep的notify来通知所有的Watcher对象更新视图 */</span>
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Vue</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_data <span class="token operator">=</span> options<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token function">observer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 新建一个Watcher观察者对象，这时候Dep.target会指向这个Watcher对象 */</span>
        <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 在这里模拟render的过程，为了触发test属性的get函数 */</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'render~'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">.</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h2> <p>总结一下。</p> <p>首先在 <code>observer</code> 的过程中会注册 get 方法，该方法用来进行 <strong>「依赖收集」</strong> 。在它的闭包中会有一个 Dep 对象，这个对象用来存放 Watcher 对象的实例。其实「依赖收集」的过程就是把 Watcher 实例存放到对应的 Dep 对象中去。<code>get</code> 方法可以让当前的 <code>Watcher</code> 对象（Dep.target）存放到它的 subs 中（addSub）方法，在数据变化时，<code>set</code> 会调用 <code>Dep</code> 对象的 <code>notify</code> 方法通知它内部所有的 Watcher 对象进行视图更新。</p> <p>这是 <code>Object.defineProperty</code> 的 <code>set/get</code> 方法处理的事情，那么「依赖收集」的前提条件还有两个：</p> <p>触发 get 方法；
新建一个 <code>Watcher</code> 对象。
这个我们在 Vue 的构造类中处理。新建一个 Watcher 对象只需要 new 出来，这时候 <code>Dep.target</code> 已经指向了这个 new 出来的 Watcher 对象来。而触发 get 方法也很简单，实际上只要把 render function 进行渲染，那么其中的依赖的对象都会被「读取」，这里我们通过打印来模拟这个过程，读取 test 来触发 get 进行「依赖收集」。</p> <p>本章我们介绍了「依赖收集」的过程，配合之前的响应式原理，已经把整个「响应式系统」介绍完毕了。其主要就是 get 进行「依赖收集」。set 通过观察者来更新视图，配合下图仔细捋一捋，相信一定能搞懂它！</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/blog/Vue/mechanism/b-responsive.html" class="prev">
          响应式系统的基本原理
        </a></span> <span class="next"><a href="/blog/blog/Vue/mechanism/d-virtualDOM.html">
          实现 Virtual DOM 下的一个 VNode 节点
        </a>
        →
      </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----></div></div>
    <script src="/blog/assets/js/27.b5fe4b73.js" defer></script><script src="/blog/assets/js/app.99e55c7a.js" defer></script>
  </body>
</html>
